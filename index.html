<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>é”€å”®æ™ºåº“ Â· ç®¡ç†ç³»ç»Ÿ</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root { --primary:#2563eb; --bg:#f1f5f9; }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;padding-top:70px;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont}
    .search-box{position:fixed;top:0;left:0;right:0;z-index:50;background:#fff;padding:12px 20px;display:flex;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,.05)}
    .search-input{flex:1;border:none;background:#f1f5f9;padding:12px 16px;border-radius:20px}
    .add-btn{background:var(--primary);color:#fff;border:none;width:40px;height:40px;border-radius:50%;font-size:26px}
    .filter-scroll{display:flex;gap:10px;overflow-x:auto;padding:10px 0}
    .filter-btn{padding:8px 16px;border-radius:20px;background:#fff;border:1px solid #e2e8f0;font-size:13px}
    .filter-btn.active{background:var(--primary);color:#fff}
    .card{background:#fff;border-radius:16px;padding:18px;margin-bottom:15px;position:relative}
    .delete-btn{position:absolute;top:12px;right:12px;color:#cbd5e1;font-size:16px}
    .card-tag{font-size:11px;padding:4px 10px;border-radius:6px;font-weight:700}
    .tag-æˆäº¤æ¡ˆä¾‹{background:#dcfce7;color:#166534}
    .tag-å¤§å•æ€è·¯{background:#fef9c3;color:#854d0e}
    .tag-ç–‘è™‘è§£ç­”{background:#fee2e2;color:#991b1b}
    .tag-è¯æœ¯æŠ€å·§{background:#dbeafe;color:#1e40af}
    .card-title{font-size:17px;font-weight:700;margin:10px 0}
    .card-content{font-size:14px;color:#64748b;line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .card-footer{margin-top:10px;font-size:12px;color:#94a3b8;display:flex;justify-content:space-between}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:flex-end;z-index:100}
    .modal{background:#fff;width:100%;height:85vh;border-radius:24px 24px 0 0;padding:25px;overflow-y:auto}
    .form-control{width:100%;padding:14px;margin-bottom:15px;border-radius:12px;border:1px solid #e2e8f0}
    .btn{width:100%;padding:16px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700}
  </style>
</head>
<body>

<div class="search-box">
  <input class="search-input" id="searchInput" placeholder="ğŸ” æœç´¢" oninput="renderList()" />
  <button class="add-btn" onclick="openModal('loginModal')">âš™ï¸</button>
</div>

<div class="filter-scroll">
  <div class="filter-btn active" onclick="setFilter('all',this)">å…¨éƒ¨</div>
  <div class="filter-btn" onclick="setFilter('ç–‘è™‘è§£ç­”',this)">ç–‘è™‘è§£ç­”</div>
  <div class="filter-btn" onclick="setFilter('æˆäº¤æ¡ˆä¾‹',this)">æˆäº¤æ¡ˆä¾‹</div>
  <div class="filter-btn" onclick="setFilter('å¤§å•æ€è·¯',this)">å¤§å•æ€è·¯</div>
  <div class="filter-btn" onclick="setFilter('è¯æœ¯æŠ€å·§',this)">è¯æœ¯æŠ€å·§</div>
</div>

<div id="grid"></div>

<!-- ç™»å½• -->
<div class="modal-overlay" id="loginModal">
  <div class="modal">
    <h2>ç®¡ç†å‘˜ç™»å½•</h2>
    <input id="loginUser" class="form-control" placeholder="è´¦å·" />
    <input id="loginPass" type="password" class="form-control" placeholder="å¯†ç " />
    <button class="btn" onclick="doLogin()">ç™»å½•</button>
    <button class="btn" style="background:#e5e7eb;color:#333;margin-top:10px" onclick="closeModal('loginModal')">å…³é—­</button>
  </div>
</div>

<!-- å‘å¸ƒ -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h2>å‘å¸ƒå†…å®¹</h2>
    <select id="inputType" class="form-control"><option>ç–‘è™‘è§£ç­”</option><option>æˆäº¤æ¡ˆä¾‹</option><option>å¤§å•æ€è·¯</option><option>è¯æœ¯æŠ€å·§</option></select>
    <input id="inputTitle" class="form-control" placeholder="æ ‡é¢˜" />
    <textarea id="inputContent" class="form-control" placeholder="å†…å®¹"></textarea>
    <input id="inputAuthor" class="form-control" placeholder="ä½œè€…" />
    <button class="btn" onclick="saveData()">å‘å¸ƒ</button>
    <button class="btn" style="background:#e5e7eb;color:#333;margin-top:10px" onclick="closeModal('addModal')">å…³é—­</button>
  </div>
</div>

<script>
const APP_ID='711a5754d90f2ed8dcafc8ebb1b640cd'
const REST_KEY='440f810266f7e9b5a3e50b59480d7e2e'
const BASE_URL='https://api.bmobcloud.com/1/classes/SalesData'
const LOGIN_KEY='sales_admin_login'

let allData=[],currentFilter='all'

async function apiRequest(method,url,body){
  const res=await fetch(url,{method,headers:{'X-Bmob-Application-Id':APP_ID,'X-Bmob-REST-API-Key':REST_KEY,'Content-Type':'application/json'},body:body?JSON.stringify(body):null})
  return res.json()
}

async function loadData(){
  const res=await apiRequest('GET',BASE_URL+'?order=-createdAt&limit=300')
  allData=res.results||[]
  renderList()
}

function isAdmin(){
  const d=localStorage.getItem(LOGIN_KEY)
  if(!d) return false
  const o=JSON.parse(d)
  return Date.now()-o.time<7*24*60*60*1000
}

async function adminLogin(u,p){
  const where=encodeURIComponent(JSON.stringify({username:u,password:p,enabled:true}))
  const res=await apiRequest('GET','https://api.bmobcloud.com/1/classes/AdminUser?where='+where+'&limit=1')
  if(res.results&&res.results.length){
    localStorage.setItem(LOGIN_KEY,JSON.stringify({u,time:Date.now()}))
    return true
  }
  return false
}

async function doLogin(){
  const ok=await adminLogin(loginUser.value,loginPass.value)
  if(ok){alert('ç™»å½•æˆåŠŸ');closeModal('loginModal');openModal('addModal')}
  else alert('è´¦å·æˆ–å¯†ç é”™è¯¯')
}

async function saveData(){
  if(!isAdmin()) return alert('è¯·å…ˆç™»å½•ç®¡ç†å‘˜')
  await apiRequest('POST',BASE_URL,{type:inputType.value,title:inputTitle.value,content:inputContent.value,author:inputAuthor.value||'åŒ¿å'})
  closeModal('addModal');loadData()
}

async function deleteItem(id){
  if(!isAdmin()) return
  if(confirm('ç¡®è®¤åˆ é™¤?')){await apiRequest('DELETE',BASE_URL+'/'+id);loadData()}
}

function renderList(){
  const g=document.getElementById('grid')
  const s=(searchInput.value||'').toLowerCase()
  g.innerHTML=''
  allData.filter(i=>(currentFilter==='all'||i.type===currentFilter)&&((i.title||'').toLowerCase().includes(s)||(i.content||'').toLowerCase().includes(s)))
    .forEach(i=>{
      const d=document.createElement('div')
      d.className='card'
      d.innerHTML=`${isAdmin()?`<div class='delete-btn' onclick="deleteItem('${i.objectId}')">ğŸ—‘ï¸</div>`:''}<span class='card-tag tag-${i.type}'>${i.type}</span><div class='card-title'>${i.title}</div><div class='card-content'>${i.content}</div><div class='card-footer'><span>${i.author||'åŒ¿å'}</span><span>${i.createdAt?.split(' ')[0]}</span></div>`
      g.appendChild(d)
    })
}

function setFilter(t,b){currentFilter=t;document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');renderList()}
function openModal(id){document.getElementById(id).style.display='flex'}
function closeModal(id){document.getElementById(id).style.display='none'}

loadData()
</script>
</body>
</html>
